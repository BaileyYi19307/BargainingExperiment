{{ block title }}
    Page title
{{ endblock }}
{{ block content }}

<div class="header-container">
    <div class="values-container">
        <div id="player-values">
            P1: <span id="p1-value">__</span>
            P2: <span id="p2-value">__</span>
            P3: <span id="p3-value">__</span>
        </div>

        <div id="hover-values">
            <span id="hover-p1-value"></span> <span id="hover-p2-value"></span><span id="hover-p3-value"></span>
        </div>
    </div>

    <div class="timers-container">
        <div id="timer">
            Time left:
        </div>

        <div id="agreement-timer">
            Agree:
        </div>
    </div>
</div>



<div class="parent-container">
    <div id="triangleContainer"></div>
</div>


<script>

    window.redFillTimeouts = {};

    document.addEventListener('DOMContentLoaded', function() {
        var totalNodes = 28; // define total num of circles
        var totalPoints = 15; // define total num of points to distribute
        generateTriangle(totalNodes, totalPoints);
        {#startTimer(100);#}
    });

    function startTimer(duration) {
        var display = document.getElementById('timer');
        var timer = duration, minutes, seconds;
        var interval = setInterval(function () {
            minutes = parseInt(timer / 60, 10);
            seconds = parseInt(timer % 60, 10);

            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;

            display.textContent = 'Time left: ' + minutes + ":" + seconds;

            if (--timer < 0) {
                clearInterval(interval);
                var form = document.querySelector('form');
                if(form) {
                    form.submit();
                }
            }
        }, 1000);
    }

    window.agreementInterval = null;

    function startAgreementTimer(buttonId) {
        if (window.agreementInterval) {
            clearInterval(window.agreementInterval);
        }

        var agreementTimeLeft = 10; // agreement time
        var display = document.getElementById('agreement-timer');
        display.textContent = 'Agree: '; // Initialize with 5 seconds

        window.agreementInterval = setInterval(function () {
            agreementTimeLeft--;
            display.textContent = 'Agree: ' + agreementTimeLeft;
            if (agreementTimeLeft <= 0) {
                clearInterval(window.agreementInterval);
                document.querySelector('form').submit(); // Submit the form to move to the next screen
            } else {
                // Check if the button still has an agreement
                if (!document.getElementById(buttonId).classList.contains('red-fill')) {
                    clearInterval(window.agreementInterval);
                    display.textContent = 'Agree: '; // Reset the agreement timer display
                }
            }
        }, 1000);
    }

    function generateTriangle(n, points) {
        const container = document.getElementById('triangleContainer');
        const numRows = Math.floor(Math.sqrt(2 * n + 0.25) - 0.5);
        window.buttonStates = {};  // Ensure this is empty before populating

        var bottomP = 0;

        const mappings = {
            1: (bottomP, leftP, rightP) => ({bottomP, leftP, rightP}),
            2: (bottomP, leftP, rightP) => ({bottomP: rightP, leftP: bottomP, rightP: leftP}),
            3: (bottomP, leftP, rightP) => ({bottomP: leftP, leftP: rightP, rightP: bottomP})
        };

        for (var rowNum = numRows; rowNum >= 1; rowNum--) {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'triangle-row';
            var leftP = rowNum - 1;
            var rightP = 0;
            const scalingFactor = points / (numRows - 1);

            for (var buttonNum = 1; buttonNum <= rowNum; buttonNum++) {
                const {bottomP: rawBottomP, leftP: rawLeftP, rightP: rawRightP} = mappings[window.playerId](bottomP, leftP, rightP);
                const scaledBottomP = formatCoordinate(rawBottomP * scalingFactor);
                const scaledLeftP = formatCoordinate(rawLeftP * scalingFactor);
                const scaledRightP = formatCoordinate(rawRightP * scalingFactor);
                const buttonId = `btn${scaledBottomP}_${scaledLeftP}_${scaledRightP}`;
                const button = document.createElement('button');
                button.dataset.coords = `(${scaledBottomP},${scaledLeftP},${scaledRightP})`; // Store coordinates in data attribute
                button.id = buttonId;
                button.className = 'button';
                button.type = 'button';
                button.addEventListener('click', function(e) {
                    test(e.target.id);  // Use e.target.id to ensure correct ID is used
                });
                rowDiv.appendChild(button);

                button.addEventListener('mouseenter', function(e) {
                    var hoverValues = e.target.dataset.coords.split(',').map(function(coord) {
                        return coord.trim().replace(/[()]/g, ''); // Remove parentheses and trim spaces
                    });
                    document.getElementById('hover-p1-value').textContent = hoverValues[0];
                    document.getElementById('hover-p2-value').textContent = hoverValues[1];
                    document.getElementById('hover-p3-value').textContent = hoverValues[2];

                     showAndPositionHoverValue('hover-p1-value', hoverValues[0], 'topLeft');
    showAndPositionHoverValue('hover-p2-value', hoverValues[1], 'topRight');
    showAndPositionHoverValue('hover-p3-value', hoverValues[2], 'bottom');
                });

                button.addEventListener('mouseleave', function() {
                    document.getElementById('hover-p1-value').textContent = '__';
                    document.getElementById('hover-p2-value').textContent = '__';
                    document.getElementById('hover-p3-value').textContent = '__';
                });

                // Initialize state for this button
                window.buttonStates[buttonId] = { clickedByUser1: false, clickedByUser2: false, clickedByUser3: false };

                leftP--;
                rightP++;
            }


            container.appendChild(rowDiv);
            bottomP++;
            leftP = rowNum - 2;
            rightP = 0;
        }
    }
function showAndPositionHoverValue(id, value, position) {
    var valueSpan = document.getElementById(id);
    valueSpan.textContent = value;
    valueSpan.style.display = 'block';

    var containerRect = document.getElementById('triangleContainer').getBoundingClientRect();


    var scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
    var scrollTop = window.pageYOffset || document.documentElement.scrollTop;

    if (position === 'topLeft') {
        valueSpan.style.left = (containerRect.left + scrollLeft-25) + 'px';
        valueSpan.style.top = (containerRect.top + scrollTop-25) + 'px';
    } else if (position === 'topRight') {
        valueSpan.style.left = (containerRect.right + scrollLeft +25 - valueSpan.offsetWidth) + 'px';
        valueSpan.style.top = (containerRect.top + scrollTop-25) + 'px';
    } else if (position === 'bottom') {
        valueSpan.style.left = (containerRect.left + scrollLeft + (containerRect.width - valueSpan.offsetWidth) / 2) + 'px';
        valueSpan.style.top = (containerRect.bottom + scrollTop +25 - valueSpan.offsetHeight) + 'px';
    }
}

    function formatCoordinate(value) {
        if (Math.floor(value) !== value) {
            return value.toFixed(1); // Rounds to one decimal point if not an integer
        }
        return value; // Returns the value as is if it's an integer
    }

    function test(buttonId) {
        liveSend({button_clicked: true, button_id:buttonId});
    }

    var borderColors = {
        red: false,
        blue: false,
        green: false
    };

    function setPlayerValues(buttonId) {
        var values = buttonId.replace('btn', '').split('_').map(Number);

        document.getElementById('p1-value').textContent = values[0];
        document.getElementById('p2-value').textContent = values[1];
        document.getElementById('p3-value').textContent = values[2];
    }

    function liveRecv(data) {
        var button = document.getElementById(data.button_id);
        var btnState = buttonStates[data.button_id];

        if (data.player_id === 1) {
            btnState.clickedByUser1 = !btnState.clickedByUser1;
        } else if (data.player_id === 2) {
            btnState.clickedByUser2 = !btnState.clickedByUser2;
        } else if (data.player_id === 3) {
            btnState.clickedByUser3 = !btnState.clickedByUser3;
        }

        Object.keys(buttonStates).forEach(function(otherButtonId) {
            if (otherButtonId !== data.button_id) {
                var otherBtnState = buttonStates[otherButtonId];
                if (data.player_id === 1) {
                    otherBtnState.clickedByUser1 = false;
                } else if (data.player_id === 2) {
                    otherBtnState.clickedByUser2 = false;
                } else if (data.player_id === 3) {
                    otherBtnState.clickedByUser3 = false;
                }
                updateButtonAppearance(document.getElementById(otherButtonId), otherBtnState);
            }
        });

        updateButtonAppearance(button, btnState);
        if (data.player_id === window.playerId) {
            setPlayerValues(data.button_id);
        }
    }


    function updateButtonAppearance(button, btnState) {
        button.classList.remove('red-border', 'blue-border', 'green-border', 'red-blue', 'red-green', 'green-blue', 'blue-red', 'green-red', 'blue-green', 'all-borders');

        var playerColor = { // color of players depending on different player's points of views
            1: {1: 'green', 2: 'red', 3: 'blue'},
            2: {1: 'blue', 2: 'green', 3: 'red'},
            3: {1: 'red', 2: 'blue', 3: 'green'}
        };

        var activePlayers = [];
        if (btnState.clickedByUser1) activePlayers.push(1);
        if (btnState.clickedByUser2) activePlayers.push(2);
        if (btnState.clickedByUser3) activePlayers.push(3);

        // Update the button's appearance based on the number of players who have clicked it
        if (activePlayers.length >= 2) {
            button.classList.add('red-fill');
            startAgreementTimer(button.id); // Only call this function to handle agreement
        } else {
            button.classList.remove('red-fill');
            if (window.agreementInterval) {
                clearInterval(window.agreementInterval);
                document.getElementById('agreement-timer').textContent = 'Agree: ';
            }
        }

        function getColorBorderClass(playerNum) {
            return playerColor[window.playerId][playerNum] + '-border';
        }

        function getCombinedColorClass(playerNum1, playerNum2) {
            var colors = [playerColor[window.playerId][playerNum1], playerColor[window.playerId][playerNum2]].sort();
            return colors.join('-');
        }

        // handling color combinations
        var activePlayers = [];
        if (btnState.clickedByUser1) activePlayers.push(1);
        if (btnState.clickedByUser2) activePlayers.push(2);
        if (btnState.clickedByUser3) activePlayers.push(3);

        if (activePlayers.length === 3) {
            button.classList.add('all-borders');
        } else if (activePlayers.length === 2) {
            button.classList.add(getCombinedColorClass(activePlayers[0], activePlayers[1]));
        } else if (activePlayers.length === 1) {
            button.classList.add(getColorBorderClass(activePlayers[0]));
        }
    }

    // get and store the player's ID
    window.playerId = {{ player.id_in_group }};

</script>

<style>

    #triangleContainer{
        display: inline-block;
    }
    .header-container {
        display: flex;
        flex-direction: column; /* Stack the child divs vertically */
        align-items: center;
    }

    .values-container, .timers-container {
        display: flex;
        justify-content: space-between;
        width: 100%; /* Take the full width of the header container */
        margin-bottom: 10px; /* Add some space between the rows */
    }

    #hover-p1-value, #hover-p2-value, #hover-p3-value {
    position: absolute;
    display: none; /* Hide initially */
}

    .player-values, #timer, #agreement-timer {
        flex-basis: 50%; /* Divide the space equally between the two elements */
        text-align: center; /* Center the text within each element */
        margin: 0;
        padding: 0;
        font-size: 20px;
    }


    .triangle-row {
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .button {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        font-size: 0px; /* Keep text hidden by default */
        line-height: 30px; /* Center text vertically */
        color: black;
        border: 1px solid #ccc;
        background-color: white;
        position: relative; /* Set position context for the pseudo-element */
        overflow: hidden; /* Prevents content from spilling out */
    }

        .button:hover {
        background-color: rgba(0, 0, 0, 0.5); /* Shading effect */
    }


    .red-border{
        border: 2px solid red;
    }

    .blue-border{
        border: 2px solid blue;
    }

    .green-border{
        border: 2px solid green;
    }

    /*.both-borders{*/
    /*    border: none; !* Remove default border *!*/
    /*    box-shadow: 0 0 0 2px red, 0 0 0 4px blue; !* Create a purple border with red and blue shadows *!*/
    /*}*/

    .red-blue{
        border: none; /* Remove default border */
        box-shadow: 0 0 0 2px red, 0 0 0 4px blue; /* Create a purple border with red and blue shadows */
    }

    .red-green{
        border: none; /* Remove default border */
        box-shadow: 0 0 0 2px red, 0 0 0 4px green; /* Create a purple border with red and blue shadows */
    }

    .green-blue{
        border: none; /* Remove default border */
        box-shadow: 0 0 0 2px green, 0 0 0 4px blue; /* Create a purple border with red and blue shadows */
    }

    .blue-red{
        border: none; /* Remove default border */
        box-shadow: 0 0 0 2px red, 0 0 0 4px blue; /* Create a purple border with red and blue shadows */
    }

    .green-red{
        border: none; /* Remove default border */
        box-shadow: 0 0 0 2px red, 0 0 0 4px green; /* Create a purple border with red and blue shadows */
    }

    .blue-green{
        border: none; /* Remove default border */
        box-shadow: 0 0 0 2px green, 0 0 0 4px blue; /* Create a purple border with red and blue shadows */
    }

    .all-borders{
        border: none; /* Remove default border */
        box-shadow: 0 0 0 2px red, 0 0 0 4px blue, 0 0 0 6px green; /* Create a purple border with red and blue shadows */
    }

    .red-fill {
        background-color: red; /* Fills the button with red color */
    }

    .layers{
        display:flex;
        flex-direction: row;
        justify-content: center;
        align-content: center;
    }

    .parent-container{
        border: 1px solid black;
        display: flex;
        align-content: center;
        justify-content: center;
    }


</style>


{{ formfields }}
{{ next_button }}


{{ endblock }}
